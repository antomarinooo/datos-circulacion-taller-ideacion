<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Circulación plaza Los Dominicos</title>
  <meta name="description" content="Tabla desde CSV en GitHub Pages.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>Gráficos de circulación plaza Los Dominicos</h1>
    <p>Plaza Los Dominicos · Rango etario × momento del día · SVG responsive</p>
  </header>

  <main>
    <section class="card">
      <p class="card-subtitle descripcion-grafico">
        Este gráfico muestra la distribución de circulación según diferentes rangos etarios y franjas horarias en la plaza.
      </p>

      <div class="figure">
        <img src="heatmap_circulacion.svg" alt="Heatmap de circulación por rango etario y momento" loading="eager" fetchpriority="high">
      </div>

      <div class="controls">
        <a class="btn" href="heatmap_circulacion.svg" download>Descargar SVG</a>
        <a class="btn" href="heatmap_circulacion.svg" target="_blank" rel="noopener">Abrir en nueva pestaña</a>
        <a class="btn" href="lamina-certamen-taller-ideacion.pdf" target="_blank" rel="noopener">Abrir lámina principal (PDF)</a>
        <span class="meta" id="status" aria-live="polite"></span>
      </div>
    </section>

    <!-- Contenedor para la tabla construida desde el CSV -->
    <section class="card">
      <h2 style="margin-top:0">Tabla de datos (CSV)</h2>
      <div id="csv-table">Cargando datos…</div>
    </section>
  </main>

  <footer>
    Lunes 25 de Agosto de 2025 | Taller de ideación y creatividad | Sección 1 | Publicado con GitHub Pages.
  </footer>

  <!-- Script para leer y mostrar el CSV -->
  <script>
    const CSV_URL = 'Datos-circulacion-plaza-los-dominicos-Sheet1-2.csv';

    function parseCSV(text) {
      const rows = [];
      let cur = '', inQuotes = false, row = [];
      for (let i = 0; i < text.length; i++) {
        const c = text[i], n = text[i+1];
        if (c === '"' && inQuotes && n === '"') { cur += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }
        if (c === ',' && !inQuotes) { row.push(cur); cur = ''; continue; }
        if ((c === '\\n' || c === '\\r') && !inQuotes) {
          if (cur.length || row.length) { row.push(cur); rows.push(row); }
          cur = ''; row = [];
          if (c === '\\r' && n === '\\n') i++;
          continue;
        }
        cur += c;
      }
      if (cur.length || row.length) { row.push(cur); rows.push(row); }
      return rows;
    }

    function removeEmptyRows(rows) {
      return rows.filter(r => r.some(cell => String(cell).trim() !== ''));
    }

    function toTable(rows) {
      if (!rows.length) return '<p>No hay datos.</p>';
      const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      let html = '<table class="table">';
      // Dibuja cada fila, detectando filas-título (una sola celda no vacía)
      for (const r of rows) {
        const nonEmpty = r.filter(c => c.trim() !== '');
        const onlyTitle = nonEmpty.length === 1 && r.join('').trim().length > 0;
        if (onlyTitle) {
          html += `<tr><th class="table-title" colspan="100">${esc(nonEmpty[0])}</th></tr>`;
          continue;
        }
        html += '<tr>';
        for (const c of r) {
          html += `<td>${esc(c)}</td>`;
        }
        html += '</tr>';
      }
      html += '</table>';
      return html;
    }

    fetch(CSV_URL)
      .then(r => { if (!r.ok) throw new Error('No se pudo cargar el CSV'); return r.text(); })
      .then(text => {
        let rows = parseCSV(text);
        rows = removeEmptyRows(rows);
        document.getElementById('csv-table').innerHTML = toTable(rows);
      })
      .catch(err => {
        document.getElementById('csv-table').textContent = 'Error cargando CSV: ' + err.message;
      });
  </script>
</body>
</html>